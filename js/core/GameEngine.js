// ÈÅäÊà≤Ê†∏ÂøÉÂºïÊìé
import { Player } from '../entities/Player.js';
import { EchoSystem } from '../systems/EchoSystem.js';
import { LevelManager } from '../levels/LevelManager.js';
import { PhysicsEngine } from '../physics/PhysicsEngine.js';
import { InputHandler } from '../input/InputHandler.js';
import { Logger } from '../utils/Logger.js';

export class GameEngine {
    constructor() {
        this.canvas = null;
        this.ctx = null;
        this.player = null;
        this.echoSystem = null;
        this.levelManager = null;
        this.physicsEngine = null;
        this.inputHandler = null;
        
        // ÁÆ°ÁêÜÂô®ÂºïÁî®
        this.uiManager = null;
        this.audioManager = null;
        this.saveManager = null;
        
        // ÈÅäÊà≤ÁãÄÊÖã
        this.gameState = {
            currentChapter: 1,
            currentLevel: 1,
            isPlaying: false,
            isPaused: false,
            gameTime: 0,
            echoCount: 0
        };
        
        // Ê∏≤ÊüìÁõ∏Èóú
        this.lastFrameTime = 0;
        this.deltaTime = 0;
        this.fps = 60;
        this.frameCount = 0;
        
        // ÈÅäÊà≤Âæ™Áí∞
        this.gameLoop = this.gameLoop.bind(this);
        this.isRunning = false;
    }

    async init() {
        console.log('üéÆ ÂàùÂßãÂåñÈÅäÊà≤ÂºïÊìé...');
        
        // Áç≤ÂèñÁï´Â∏É
        this.canvas = document.getElementById('game-canvas');
        if (!this.canvas) {
            throw new Error('Êâæ‰∏çÂà∞ÈÅäÊà≤Áï´Â∏ÉÂÖÉÁ¥†');
        }
        
        this.ctx = this.canvas.getContext('2d');
        this.setupCanvas();
        
        // ÂàùÂßãÂåñÂêÑÂÄãÁ≥ªÁµ±
        this.inputHandler = new InputHandler(this);
        this.physicsEngine = new PhysicsEngine();
        this.echoSystem = new EchoSystem(this);
        this.levelManager = new LevelManager(this);
        this.player = new Player(this);
        
        // ÂàùÂßãÂåñÁ≥ªÁµ±
        await this.inputHandler.init();
        await this.physicsEngine.init();
        await this.echoSystem.init();
        await this.levelManager.init();
        await this.player.init();
        
        console.log('‚úÖ ÈÅäÊà≤ÂºïÊìéÂàùÂßãÂåñÂÆåÊàê');
    }

    setManagers(managers) {
        this.uiManager = managers.ui;
        this.audioManager = managers.audio;
        this.saveManager = managers.save;
    }

    setupCanvas() {
        // Ë®≠ÁΩÆÁï´Â∏ÉÂ§ßÂ∞è
        this.resizeCanvas();
        
        // Ë®≠ÁΩÆÊ∏≤ÊüìÂìÅË≥™
        this.ctx.imageSmoothingEnabled = true;
        this.ctx.imageSmoothingQuality = 'high';
        
        // Ë®≠ÁΩÆÂ≠óÈ´î
        this.ctx.font = '16px Microsoft JhengHei, sans-serif';
        this.ctx.textAlign = 'left';
        this.ctx.textBaseline = 'top';
    }

    resizeCanvas() {
        const container = this.canvas.parentElement;
        const rect = container.getBoundingClientRect();
        
        this.canvas.width = rect.width;
        this.canvas.height = rect.height;
        
        // Êõ¥Êñ∞ÈÅäÊà≤‰∏ñÁïåÂ∞∫ÂØ∏
        this.worldWidth = this.canvas.width;
        this.worldHeight = this.canvas.height;
    }

    async startChapter(chapterNumber) {
        console.log(`üìñ ÈñãÂßãÁ¨¨${chapterNumber}Á´†`);
        
        this.gameState.currentChapter = chapterNumber;
        this.gameState.currentLevel = 1;
        this.gameState.isPlaying = true;
        this.gameState.gameTime = 0;
        this.gameState.echoCount = 0;
        
        // Á¢∫‰øùÊâÄÊúâÁ≥ªÁµ±ÈÉΩÂ∑≤ÂàùÂßãÂåñ
        if (!this.player || !this.levelManager || !this.echoSystem) {
            console.error('‚ùå ÈÅäÊà≤Á≥ªÁµ±Êú™ÂÆåÂÖ®ÂàùÂßãÂåñ');
            return;
        }
        
        // ËºâÂÖ•Á´†ÁØÄ
        await this.levelManager.loadChapter(chapterNumber);
        
        // ÈáçÁΩÆÁé©ÂÆ∂‰ΩçÁΩÆ
        this.player.reset();
        
        // Ê∏ÖÈô§ÊâÄÊúâÊÆòÂΩ±
        this.echoSystem.clearAllEchoes();
        
        // Êõ¥Êñ∞UI
        this.updateUI();
        
        // Êí≠ÊîæÁ´†ÁØÄÈñãÂßãÈü≥Êïà
        this.audioManager?.playSound('chapter-start');
        
        // È°ØÁ§∫Á´†ÁØÄÊ®ôÈ°å
        this.uiManager?.showChapterTitle(this.levelManager.getChapterTitle(chapterNumber));
        
        // ÈñãÂßãÈÅäÊà≤Âæ™Áí∞
        this.startGameLoop();
        
        console.log('‚úÖ Á´†ÁØÄÂïüÂãïÂÆåÊàêÔºåÁé©ÂÆ∂ÊáâË©≤ÂèØË¶ã');
        console.log(`üéÆ ÈÅäÊà≤ÁãÄÊÖã: isPlaying=${this.gameState.isPlaying}, isRunning=${this.isRunning}`);
        console.log(`üë§ Áé©ÂÆ∂ÁãÄÊÖã: ‰ΩçÁΩÆ(${this.player.x}, ${this.player.y}), Â≠òÊ¥ª=${this.player.isAlive}`);
    }

    startGameLoop() {
        if (this.isRunning) return;
        
        this.isRunning = true;
        this.lastFrameTime = performance.now();
        console.log('üîÑ ÈÅäÊà≤Âæ™Áí∞Â∑≤ÂïüÂãï');
        requestAnimationFrame(this.gameLoop);
    }

    stopGameLoop() {
        this.isRunning = false;
    }

    gameLoop(currentTime) {
        if (!this.isRunning) return;
        
        // Ë®àÁÆóÊôÇÈñìÂ∑Æ
        this.deltaTime = (currentTime - this.lastFrameTime) / 1000;
        this.lastFrameTime = currentTime;
        
        // ÈôêÂà∂ÊúÄÂ§ßÊôÇÈñìÊ≠•Èï∑
        this.deltaTime = Math.min(this.deltaTime, 1/30);
        
        // Êõ¥Êñ∞ÈÅäÊà≤ÁãÄÊÖã
        if (this.gameState.isPlaying && !this.gameState.isPaused) {
            this.update(this.deltaTime);
        }
        
        // Ê∏≤ÊüìÈÅäÊà≤
        this.render();
        
        // Êõ¥Êñ∞ÂπÄË®àÊï∏
        this.frameCount++;
        if (this.frameCount % 60 === 0) {
            this.fps = Math.round(1 / this.deltaTime);
        }
        
        // ÁπºÁ∫åÈÅäÊà≤Âæ™Áí∞
        requestAnimationFrame(this.gameLoop);
    }

    update(deltaTime) {
        // Êõ¥Êñ∞ÈÅäÊà≤ÊôÇÈñì
        this.gameState.gameTime += deltaTime;
        
        // Êõ¥Êñ∞Ëº∏ÂÖ•ËôïÁêÜ
        this.inputHandler.update(deltaTime);
        
        // Êõ¥Êñ∞Áé©ÂÆ∂
        this.player.update(deltaTime);
        
        // Êõ¥Êñ∞ÊÆòÂΩ±Á≥ªÁµ±
        this.echoSystem.update(deltaTime);
        
        // Êõ¥Êñ∞Áâ©ÁêÜÂºïÊìé
        if (this.physicsEngine) {
            this.physicsEngine.update(deltaTime);
        }
        
        // Êõ¥Êñ∞ÈóúÂç°
        this.levelManager.update(deltaTime);
        
        // Ê™¢Êü•ÈÅäÊà≤ÁãÄÊÖã
        this.checkGameConditions();
    }

    render() {
        // Ê∏ÖÈô§Áï´Â∏É
        this.ctx.fillStyle = '#0a0a0a';
        this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
        
        // Ê∏≤ÊüìËÉåÊôØ
        this.renderBackground();
        
        // Ê∏≤ÊüìÈóúÂç°
        this.levelManager.render(this.ctx);
        
        // Ê∏≤ÊüìÊÆòÂΩ±
        this.echoSystem.render(this.ctx);
        
        // Ê∏≤ÊüìÁé©ÂÆ∂
        if (this.player) {
            this.player.render(this.ctx);
        } else {
            console.warn('‚ö†Ô∏è Áé©ÂÆ∂Áâ©‰ª∂‰∏çÂ≠òÂú®ÔºåÁÑ°Ê≥ïÊ∏≤Êüì');
        }
        
        // Ê∏≤ÊüìUIË¶ÜËìãÂ±§
        this.renderUIOverlay();
        
        // Ê∏≤ÊüìË™øË©¶‰ø°ÊÅØ
        if (this.isDebugMode()) {
            this.renderDebugInfo();
        }
    }

    renderBackground() {
        // ÊôÇÈñìÊâ≠Êõ≤ËÉåÊôØÊïàÊûú
        const gradient = this.ctx.createRadialGradient(
            this.canvas.width / 2, this.canvas.height / 2, 0,
            this.canvas.width / 2, this.canvas.height / 2, Math.max(this.canvas.width, this.canvas.height)
        );
        
        const time = this.gameState.gameTime;
        const alpha1 = 0.1 + 0.05 * Math.sin(time * 0.5);
        const alpha2 = 0.05 + 0.03 * Math.cos(time * 0.3);
        
        gradient.addColorStop(0, `rgba(64, 224, 208, ${alpha1})`);
        gradient.addColorStop(0.5, `rgba(138, 43, 226, ${alpha2})`);
        gradient.addColorStop(1, 'rgba(10, 10, 10, 0.8)');
        
        this.ctx.fillStyle = gradient;
        this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
    }

    renderUIOverlay() {
        // Ê∏≤ÊüìÂ∞èÂú∞Âúñ
        this.renderMinimap();
        
        // Ê∏≤ÊüìË°ÄÈáèÊ¢ù
        this.renderHealthBar();
        
        // Ê∏≤ÊüìËÉΩÈáèÊ¢ù
        this.renderEnergyBar();
    }

    renderMinimap() {
        const minimapSize = 120;
        const x = this.canvas.width - minimapSize - 20;
        const y = this.canvas.height - minimapSize - 20;
        
        // ËÉåÊôØ
        this.ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
        this.ctx.fillRect(x, y, minimapSize, minimapSize);
        
        this.ctx.strokeStyle = 'rgba(64, 224, 208, 0.5)';
        this.ctx.lineWidth = 2;
        this.ctx.strokeRect(x, y, minimapSize, minimapSize);
        
        // Áé©ÂÆ∂‰ΩçÁΩÆ
        const playerX = x + (this.player.x / this.worldWidth) * minimapSize;
        const playerY = y + (this.player.y / this.worldHeight) * minimapSize;
        
        this.ctx.fillStyle = '#ff6b6b';
        this.ctx.beginPath();
        this.ctx.arc(playerX, playerY, 3, 0, Math.PI * 2);
        this.ctx.fill();
        
        // ÊÆòÂΩ±‰ΩçÁΩÆ
        this.ctx.fillStyle = '#40e0d0';
        this.echoSystem.echoes.forEach(echo => {
            const echoX = x + (echo.x / this.worldWidth) * minimapSize;
            const echoY = y + (echo.y / this.worldHeight) * minimapSize;
            
            this.ctx.beginPath();
            this.ctx.arc(echoX, echoY, 2, 0, Math.PI * 2);
            this.ctx.fill();
        });
    }

    renderHealthBar() {
        const barWidth = 150;
        const barHeight = 8;
        const x = 20;
        const y = 20;
        
        // ËÉåÊôØ
        this.ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
        this.ctx.fillRect(x, y, barWidth, barHeight);
        
        // ÈÇäÊ°Ü
        this.ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
        this.ctx.lineWidth = 1;
        this.ctx.strokeRect(x, y, barWidth, barHeight);
        
        // Ë°ÄÈáè
        const healthPercent = this.player.health / this.player.maxHealth;
        const healthWidth = barWidth * healthPercent;
        
        const gradient = this.ctx.createLinearGradient(x, y, x + barWidth, y);
        gradient.addColorStop(0, '#ff6b6b');
        gradient.addColorStop(1, '#ff8e8e');
        
        this.ctx.fillStyle = gradient;
        this.ctx.fillRect(x, y, healthWidth, barHeight);
    }

    renderEnergyBar() {
        const barWidth = 120;
        const barHeight = 8;
        const x = this.canvas.width - barWidth - 20;
        const y = 20;
        
        // ËÉåÊôØ
        this.ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
        this.ctx.fillRect(x, y, barWidth, barHeight);
        
        // ÈÇäÊ°Ü
        this.ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
        this.ctx.lineWidth = 1;
        this.ctx.strokeRect(x, y, barWidth, barHeight);
        
        // ËÉΩÈáè
        const energyPercent = this.player.energy / this.player.maxEnergy;
        const energyWidth = barWidth * energyPercent;
        
        const gradient = this.ctx.createLinearGradient(x, y, x + barWidth, y);
        gradient.addColorStop(0, '#40e0d0');
        gradient.addColorStop(1, '#8a2be2');
        
        this.ctx.fillStyle = gradient;
        this.ctx.fillRect(x, y, energyWidth, barHeight);
    }

    renderDebugInfo() {
        this.ctx.fillStyle = '#ffffff';
        this.ctx.font = '12px monospace';
        
        const debugInfo = [
            `FPS: ${this.fps}`,
            `Player: (${Math.round(this.player.x)}, ${Math.round(this.player.y)})`,
            `Echoes: ${this.echoSystem.echoes.length}`,
            `Chapter: ${this.gameState.currentChapter}`,
            `Level: ${this.gameState.currentLevel}`,
            `Time: ${this.gameState.gameTime.toFixed(1)}s`
        ];
        
        debugInfo.forEach((info, index) => {
            this.ctx.fillText(info, 10, 10 + index * 15);
        });
    }

    checkGameConditions() {
        // Á¢∫‰øùÈÅäÊà≤Â∑≤Á∂ìÈñãÂßã‰∏îÈóúÂç°Â∑≤ËºâÂÖ•
        if (!this.gameState.isPlaying || !this.levelManager.isLevelLoaded) {
            return;
        }
        
        // Ê™¢Êü•ÈóúÂç°ÂÆåÊàêÊ¢ù‰ª∂
        if (this.levelManager.isLevelComplete()) {
            this.completeLevel();
        }
        
        // Ê™¢Êü•Áé©ÂÆ∂Ê≠ª‰∫°
        if (this.player.health <= 0) {
            this.playerDeath();
        }
        
        // Ê™¢Êü•Á´†ÁØÄÂÆåÊàê
        if (this.levelManager.isChapterComplete()) {
            this.completeChapter();
        }
    }

    // ÈÅäÊà≤Êìç‰ΩúÊñπÊ≥ï
    createEcho() {
        if (this.player.canCreateEcho()) {
            const echo = this.echoSystem.createEcho(this.player.x, this.player.y, this.player.getState());
            this.gameState.echoCount++;
            this.updateUI();
            this.audioManager?.playSound('echo-create');
            return echo;
        }
        return null;
    }

    interact() {
        const interactable = this.levelManager.getInteractableAt(this.player.x, this.player.y);
        if (interactable) {
            interactable.interact(this.player);
            this.audioManager?.playSound('interact');
        }
    }

    completeLevel() {
        console.log('üéâ ÈóúÂç°ÂÆåÊàê');
        this.audioManager?.playSound('level-complete');
        this.uiManager?.showLevelComplete();
        
        // Ëá™Âãï‰øùÂ≠ò
        this.saveManager?.autoSave(this.getGameState());
    }

    completeChapter() {
        console.log('üèÜ Á´†ÁØÄÂÆåÊàê');
        this.audioManager?.playSound('chapter-complete');
        this.uiManager?.showChapterComplete();
    }

    playerDeath() {
        console.log('üíÄ Áé©ÂÆ∂Ê≠ª‰∫°');
        this.gameState.isPlaying = false;
        this.audioManager?.playSound('player-death');
        this.uiManager?.showGameOver();
    }

    // Ëº∏ÂÖ•ËôïÁêÜ - ÈÄô‰∫õÊñπÊ≥ïÁî± InputHandler Áõ¥Êé•ËôïÁêÜ
    handleKeyDown(event) {
        // InputHandler Â∑≤Á∂ìÊúâËá™Â∑±ÁöÑ‰∫ã‰ª∂Áõ£ËÅΩÂô®
        // ÈÄôÂÄãÊñπÊ≥ï‰øùÁïôÁî®ÊñºÂÖºÂÆπÊÄß
        if (this.inputHandler) {
            this.inputHandler.handleKeyDown(event);
        }
    }

    handleKeyUp(event) {
        // InputHandler Â∑≤Á∂ìÊúâËá™Â∑±ÁöÑ‰∫ã‰ª∂Áõ£ËÅΩÂô®
        // ÈÄôÂÄãÊñπÊ≥ï‰øùÁïôÁî®ÊñºÂÖºÂÆπÊÄß
        if (this.inputHandler) {
            this.inputHandler.handleKeyUp(event);
        }
    }

    handleResize() {
        this.resizeCanvas();
    }

    // ÈÅäÊà≤ÁãÄÊÖãÁÆ°ÁêÜ
    pauseGame() {
        this.gameState.isPaused = true;
        this.audioManager?.pauseAll();
    }

    resumeGame() {
        this.gameState.isPaused = false;
        this.audioManager?.resumeAll();
    }

    getGameState() {
        return {
            ...this.gameState,
            player: this.player.getState(),
            echoes: this.echoSystem.getState(),
            level: this.levelManager.getState()
        };
    }

    async loadGameState(saveData) {
        this.gameState = { ...saveData };
        await this.player.loadState(saveData.player);
        await this.echoSystem.loadState(saveData.echoes);
        await this.levelManager.loadState(saveData.level);
        this.updateUI();
    }

    updateUI() {
        // Êõ¥Êñ∞ÊÆòÂΩ±Ë®àÊï∏
        const echoCountElement = document.getElementById('echo-count');
        if (echoCountElement) {
            echoCountElement.textContent = this.gameState.echoCount;
        }
        
        // Êõ¥Êñ∞Á´†ÁØÄ‰ø°ÊÅØ
        const chapterTitleElement = document.getElementById('chapter-title');
        if (chapterTitleElement) {
            chapterTitleElement.textContent = this.levelManager.getChapterTitle(this.gameState.currentChapter);
        }
    }

    isGameActive() {
        return this.gameState.isPlaying;
    }

    isDebugMode() {
        return window.location.search.includes('debug=true');
    }
}